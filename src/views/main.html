<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WhispLine</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="header">
        <div class="logo">WhispLine</div>
        <div class="subline">
          <div class="badge" data-i18n="app.plan.basic">Basic</div>
          <div id="appVersion" class="app-version">v-</div>
        </div>
      </div>
    </div>

    <div class="sidebar-nav">
      <button class="nav-item active" onclick="showPage('home')">
        <span class="nav-item-icon material-icons">home</span>
        <span data-i18n="sidebar.home">Home</span>
      </button>
      <button class="nav-item" onclick="showPage('dictionary')">
        <span class="nav-item-icon material-icons">book</span>
        <span data-i18n="sidebar.dictionary">Dictionary</span>
      </button>
      <button class="nav-item">
        <span class="nav-item-icon material-icons">note</span>
        <span data-i18n="sidebar.notes">Notes</span>
      </button>
    </div>

    <div class="sidebar-footer">
      <div class="upgrade-section">
        <div class="upgrade-title">
          <span class="material-icons upgrade-icon">workspace_premium</span>
          <span data-i18n="upgrade.title">Upgrade to pro</span>
        </div>
        <div class="upgrade-description" data-i18n="upgrade.description">
          Upgrade for unlimited dictation and other pro features
        </div>
        <button class="learn-more-btn" data-i18n="upgrade.learnMore">Learn more</button>
      </div>

      <button class="nav-item" onclick="openSettings()">
        <span class="nav-item-icon material-icons">settings</span>
        <span data-i18n="sidebar.settings">Settings</span>
      </button>
      <button class="nav-item">
        <span class="nav-item-icon material-icons">group_add</span>
        <span data-i18n="sidebar.addTeam">Add your team</span>
      </button>
      <button class="nav-item">
        <span class="nav-item-icon material-icons">person_add</span>
        <span data-i18n="sidebar.referFriend">Refer a friend</span>
      </button>
      <button class="nav-item">
        <span class="nav-item-icon material-icons">help</span>
        <span data-i18n="sidebar.help">Help</span>
      </button>
    </div>
  </div>

  <div class="main-content">
    <!-- Home Page -->
    <div id="home-page" class="page active">
      <div class="feature-section">
        <div class="feature-title" data-i18n="home.featureTitle">Voice dictation in any app</div>
        <div class="feature-description" id="recordShortcutHint">
          Hold down Ctrl + Shift and speak into any textbox.
        </div>
        <div class="feature-description" id="translateShortcutHint">
          Hold down Shift + Alt to translate spoken text to English.
        </div>
        <button class="btn" onclick="exploreUseCases()" data-i18n="home.explore">
          Explore use cases
        </button>
      </div>

      <div class="recent-activity">
        <h3 data-i18n="home.recentActivity">Recent activity</h3>
        <div id="activity-container">
          <!-- Activities will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Dictionary Page -->
    <div id="dictionary-page" class="page">
      <div class="welcome">
        <h1 data-i18n="dictionary.title">Dictionary</h1>
        <p data-i18n="dictionary.subtitle">Add custom words and phrases to improve transcription accuracy</p>
      </div>

      <div class="dictionary-section">
        <div class="dictionary-form">
          <label for="dictionary-text" data-i18n="dictionary.label">Custom Dictionary Prompt:</label>
          <textarea 
            id="dictionary-text" 
            placeholder="Enter custom words, phrases, or context to help improve transcription accuracy. For example: 'Technical terms: API, JSON, OAuth, WebSocket'"
            data-i18n="dictionary.placeholder"
            data-i18n-attr="placeholder"
            rows="8"
          ></textarea>
          <div class="dictionary-actions">
            <button class="btn" onclick="saveDictionary()" data-i18n="dictionary.save">Save Dictionary</button>
          </div>
        </div>

        <div class="dictionary-help">
          <h3 data-i18n="dictionary.helpTitle">How to use the Dictionary</h3>
          <ul>
            <li data-i18n="dictionary.helpItem1">Add technical terms, proper nouns, or domain-specific vocabulary</li>
            <li data-i18n="dictionary.helpItem2">Include context or examples for better recognition</li>
            <li data-i18n="dictionary.helpItem3">Use clear, descriptive language</li>
            <li data-i18n="dictionary.helpItem4">This content will be sent as a prompt to improve transcription accuracy</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script src="i18n.js"></script>
  <script>
    const { ipcRenderer } = require("electron");
    const { initI18n, setLanguage, applyI18n, t, getLocale } = window.WhispLineI18n;
    let lastRecordShortcut = 'Ctrl+Shift';
    let lastTranslateShortcut = 'Shift+Alt';

    // Load activities when page loads
    document.addEventListener('DOMContentLoaded', async () => {
      let settings = null;
      try {
        settings = await ipcRenderer.invoke("get-settings");
      } catch (error) {
        console.error('Failed to load settings for i18n:', error);
      }
      initI18n(settings?.uiLanguage);
      await loadActivities();
      await loadDictionary();
      await loadShortcutHints();
      
      // Load app version into sidebar footer
      try {
        const version = await ipcRenderer.invoke("get-app-version");
        const el = document.getElementById('appVersion');
        if (el) el.textContent = `v${version}`;
      } catch (e) {
        console.error('Failed to load app version', e);
      }
      
      // Listen for activity updates from main process
      ipcRenderer.on('activity-updated', async () => {
        await loadActivities();
      });

      // Listen for accessibility permission changes
      ipcRenderer.on('accessibility-permission-changed', (event, data) => {
        showNotification(data.message, data.granted ? 'success' : 'warning');
      });

      ipcRenderer.on('shortcut-updated', (event, payload) => {
        if (!payload) return;
        updateShortcutHints(payload.recordShortcut, payload.translateShortcut);
      });

      ipcRenderer.on('ui-language-updated', async (event, payload) => {
        if (!payload) return;
        setLanguage(payload.language);
        applyI18n(document);
        updateShortcutHints(lastRecordShortcut, lastTranslateShortcut);
        await loadActivities();
      });
    });

    async function loadShortcutHints() {
      try {
        const settings = await ipcRenderer.invoke('get-settings');
        updateShortcutHints(settings.shortcut, settings.translateShortcut);
      } catch (error) {
        console.error('Failed to load shortcuts:', error);
        updateShortcutHints('Ctrl+Shift', 'Shift+Alt');
      }
    }

    function formatShortcutLabel(shortcut) {
      if (!shortcut) return '';
      const isMac = window.navigator?.platform?.includes('Mac');
      const label = shortcut.replace(/\+/g, ' + ');
      return isMac ? label.replace(/Alt/g, 'Option') : label;
    }

    function updateShortcutHints(recordShortcut, translateShortcut) {
      const recordHint = document.getElementById('recordShortcutHint');
      const translateHint = document.getElementById('translateShortcutHint');
      const recordLabel = formatShortcutLabel(recordShortcut || 'Ctrl+Shift');
      const translateLabel = formatShortcutLabel(translateShortcut || 'Shift+Alt');
      lastRecordShortcut = recordShortcut || lastRecordShortcut;
      lastTranslateShortcut = translateShortcut || lastTranslateShortcut;

      if (recordHint) {
        recordHint.textContent = t('home.recordHint', { shortcut: recordLabel });
      }
      if (translateHint) {
        translateHint.textContent = t('home.translateHint', { shortcut: translateLabel });
      }
    }

    // Page switching
    function showPage(pageId) {
      // Hide all pages
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      
      // Show selected page
      document.getElementById(pageId + '-page').classList.add('active');
      
      // Update navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.closest('.nav-item').classList.add('active');
    }

    // Load dictionary content
    async function loadDictionary() {
      try {
        const dictionary = await ipcRenderer.invoke("get-dictionary");
        document.getElementById('dictionary-text').value = dictionary || '';
      } catch (error) {
        console.error("Error loading dictionary:", error);
      }
    }

    // Save dictionary
    async function saveDictionary() {
      const text = document.getElementById('dictionary-text').value;
      try {
        await ipcRenderer.invoke("save-dictionary", text);
        // Show some feedback
        const button = document.querySelector('.dictionary-actions .btn');
        const originalText = button.textContent;
        button.textContent = t('dictionary.saved');
        setTimeout(() => {
          button.textContent = originalText;
        }, 2000);
      } catch (error) {
        console.error("Error saving dictionary:", error);
        alert(t('dictionary.saveError', { message: error.message }));
      }
    }

    async function loadActivities() {
      try {
        const activities = await ipcRenderer.invoke("get-recent-activities");
        displayActivities(activities);
      } catch (error) {
        console.error("Error loading activities:", error);
      }
    }

    function displayActivities(activities) {
      const container = document.getElementById('activity-container');
      if (!container) return;

      if (!Array.isArray(activities) || activities.length === 0) {
        const empty = document.createElement('p');
        empty.textContent = t('home.noActivity');
        container.replaceChildren(empty);
        return;
      }

      container.replaceChildren();

      const header = document.createElement('div');
      header.className = 'section-header';
      const headerTitle = document.createElement('h4');
      headerTitle.textContent = t('home.recentHeader');
      header.appendChild(headerTitle);
      container.appendChild(header);

      activities.forEach((activity) => {
        const locale = getLocale();
        const time = new Date(activity.timestamp).toLocaleTimeString(locale, {
          hour: '2-digit',
          minute: '2-digit',
          hour12: locale === 'en-US'
        });

        const rawText = (activity.text ?? '').toString();

        const item = document.createElement('div');
        item.className = 'activity-item';

        const content = document.createElement('div');
        content.className = 'activity-content';

        const timeEl = document.createElement('div');
        timeEl.className = 'activity-time';
        timeEl.textContent = time;

        const textEl = document.createElement('div');
        textEl.className = 'activity-text';
        textEl.textContent = rawText;

        const button = document.createElement('button');
        button.className = 'copy-btn';
        button.type = 'button';
        button.title = t('activity.copyTitle');
        button.addEventListener('click', () => {
          copyToClipboard(rawText, button);
        });

        const icon = document.createElement('span');
        icon.className = 'material-icons';
        icon.textContent = 'content_copy';

        content.appendChild(timeEl);
        content.appendChild(textEl);
        button.appendChild(icon);
        item.appendChild(content);
        item.appendChild(button);
        container.appendChild(item);
      });
    }

    function exploreUseCases() {
      // Open use cases page or documentation
      console.log("Explore use cases clicked");
    }

    function openSettings() {
      ipcRenderer.invoke("open-settings");
    }

    async function copyToClipboard(text, button) {
      try {
        await navigator.clipboard.writeText(text);
        
        // Show feedback
        const icon = button.querySelector('.material-icons');
        const originalText = icon.textContent;
        icon.textContent = 'check';
        button.style.color = '#4CAF50';
        
        setTimeout(() => {
          icon.textContent = originalText;
          button.style.color = '';
        }, 2000);
      } catch (error) {
        console.error('Failed to copy text:', error);
        
        // Show error feedback
        const icon = button.querySelector('.material-icons');
        const originalText = icon.textContent;
        icon.textContent = 'error';
        button.style.color = '#f44336';
        
        setTimeout(() => {
          icon.textContent = originalText;
          button.style.color = '';
        }, 2000);
      }
    }

    // Show notification function
    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4CAF50' : type === 'warning' ? '#FF9800' : '#2196F3'};
        color: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 400px;
        font-size: 14px;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Animate in
      setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
      }, 100);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 5000);
    }
  </script>
</body>
</html>
